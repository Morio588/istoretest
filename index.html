<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iStore éŠ·å”®åˆ†æç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e7ff;
            color: #667eea;
            margin-left: 10px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f8f9ff;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item span {
            font-size: 14px;
            color: #333;
        }

        .file-item .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        .control-item label {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .control-item select,
        .control-item input {
            padding: 10px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .results {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e7ff;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        input[type="file"] {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e7ff;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š iStore éŠ·å”®åˆ†æç³»çµ±</h1>
            <p class="subtitle">å¼·å¤§çš„å¤šé€±æœŸéŠ·å”®æ•¸æ“šåˆ†æèˆ‡è¦–è¦ºåŒ–å·¥å…·</p>
        </div>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px; color: #333;">æ­¥é©Ÿ 1ï¼šä¸Šå‚³åƒç…§è³‡æ–™</h2>
            <div class="upload-area" id="refUploadArea">
                <div class="upload-icon">ğŸ“‹</div>
                <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                    æ‹–æ”¾åƒç…§è³‡æ–™æª”æ¡ˆåˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
                </p>
                <p style="font-size: 14px; color: #999;">
                    æ”¯æ´æ ¼å¼ï¼šç«‹å±•åƒç…§è³‡æ–™Care.xlsx
                </p>
                <input type="file" id="refFileInput" accept=".xlsx,.xls">
                <button class="btn btn-primary" onclick="document.getElementById('refFileInput').click()">
                    é¸æ“‡åƒç…§è³‡æ–™
                </button>
            </div>
            <div id="refFileStatus" class="file-list"></div>
        </div>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px; color: #333;">æ­¥é©Ÿ 2ï¼šä¸Šå‚³éŠ·å”®å ±è¡¨</h2>
            <div class="upload-area" id="salesUploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p style="font-size: 16px; color: #666; margin-bottom: 10px;">
                    æ‹–æ”¾éŠ·å”®å ±è¡¨åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
                </p>
                <p style="font-size: 14px; color: #999;">
                    æ”¯æ´æ ¼å¼ï¼š.xls / .xlsxï¼ˆå¯ä¸€æ¬¡ä¸Šå‚³å¤šå€‹ï¼‰
                </p>
                <input type="file" id="salesFileInput" accept=".xlsx,.xls" multiple>
                <button class="btn btn-primary" onclick="document.getElementById('salesFileInput').click()">
                    é¸æ“‡éŠ·å”®å ±è¡¨
                </button>
                <button class="btn btn-secondary" onclick="clearSalesFiles()">æ¸…é™¤æ‰€æœ‰</button>
            </div>
            <div id="salesFileList" class="file-list"></div>
        </div>

        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <p>æ­£åœ¨è™•ç†æ•¸æ“š...</p>
        </div>

        <div id="analysisSection" class="hidden">
            <div class="controls">
                <h2 style="margin-bottom: 15px; color: #333;">åˆ†ææ§åˆ¶é¢æ¿</h2>
                <div class="control-group">
                    <div class="control-item">
                        <label>é¸æ“‡é€±æœŸ</label>
                        <select id="periodSelect" multiple style="height: 120px;">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="control-item">
                        <label>é¸æ“‡å€åŸŸ</label>
                        <select id="regionSelect">
                            <option value="all">å…¨ç¤¾ï¼ˆæ‰€æœ‰å€åŸŸï¼‰</option>
                            <option value="north1">åŒ—ä¸€å€</option>
                            <option value="north2">åŒ—äºŒå€</option>
                            <option value="central">ä¸­å€</option>
                            <option value="tainan">å°å—å€</option>
                            <option value="kaohsiung">é«˜é›„å€</option>
                            <option value="online">ç·šä¸ŠEC</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>é¸æ“‡åº—é‹ª</label>
                        <select id="storeSelect">
                            <option value="all">å…¨éƒ¨åº—é‹ª</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="analyzeData()">
                    ğŸ” é–‹å§‹åˆ†æ
                </button>
            </div>

            <div id="resultsSection" class="hidden">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('summary')">ğŸ“ˆ çµ±è¨ˆç¸½è¦½</button>
                    <button class="tab" onclick="switchTab('detail')">ğŸ“Š è©³ç´°æ•¸æ“š</button>
                    <button class="tab" onclick="switchTab('chart')">ğŸ“‰ è¶¨å‹¢åœ–è¡¨</button>
                </div>

                <div id="summaryTab" class="tab-content active">
                    <div class="stat-cards" id="statCards"></div>
                    <div class="results">
                        <h2>å¤§åˆ†é¡éŠ·å”®çµ±è¨ˆ</h2>
                        <div id="summaryTable"></div>
                    </div>
                </div>

                <div id="detailTab" class="tab-content">
                    <div class="results">
                        <h2>å„é€±æœŸè©³ç´°æ•¸æ“š</h2>
                        <div id="detailTable"></div>
                    </div>
                </div>

                <div id="chartTab" class="tab-content">
                    <div class="chart-container">
                        <h2>éŠ·å”®æ•¸é‡è¶¨å‹¢åœ–</h2>
                        <div class="chart-wrapper">
                            <canvas id="qtyChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h2>éŠ·å”®é‡‘é¡è¶¨å‹¢åœ–</h2>
                        <div class="chart-wrapper">
                            <canvas id="amtChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let refData = null;
        let salesDataList = [];
        let processedData = null;

        // åº—é‹ªçµæ§‹å®šç¾©
        const REGIONS = {
            north1: { name: 'åŒ—ä¸€å€', stores: [45, 47, 48] },
            north2: { name: 'åŒ—äºŒå€', stores: [51, 57, 61, 65] },
            central: { name: 'ä¸­å€', stores: [75, 76, 77, 81, 84] },
            tainan: { name: 'å°å—å€', stores: [86, 88, 89, 97] },
            kaohsiung: { name: 'é«˜é›„å€', stores: [115, 116, 117] },
            online: { name: 'ç·šä¸ŠEC', stores: [820, 821] }
        };

        // å¤§åˆ†é¡å®šç¾©
        const MAIN_CATEGORIES = ['CPU', 'iPad', 'iPhone', 'Apple Watch', 'AirPods', 'Care', 'Accy', 'Audio', '3rd Party'];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInputs();
        });

        // è¨­ç½®æ‹–æ”¾åŠŸèƒ½
        function setupDragAndDrop() {
            const refArea = document.getElementById('refUploadArea');
            const salesArea = document.getElementById('salesUploadArea');

            [refArea, salesArea].forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (area === refArea) {
                        handleRefFile(files[0]);
                    } else {
                        handleSalesFiles(files);
                    }
                });
            });
        }

        // è¨­ç½®æ–‡ä»¶è¼¸å…¥
        function setupFileInputs() {
            document.getElementById('refFileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleRefFile(e.target.files[0]);
                }
            });

            document.getElementById('salesFileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleSalesFiles(e.target.files);
                }
            });
        }

        // è™•ç†åƒç…§è³‡æ–™
        async function handleRefFile(file) {
            try {
                const data = await readExcelFile(file);
                refData = data;
                document.getElementById('refFileStatus').innerHTML = `
                    <div class="success">
                        âœ… åƒç…§è³‡æ–™å·²è¼‰å…¥ï¼š${file.name}ï¼ˆ${data.length.toLocaleString()} ç­†ç”¢å“è³‡æ–™ï¼‰
                    </div>
                `;
            } catch (error) {
                document.getElementById('refFileStatus').innerHTML = `
                    <div class="error">
                        âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }

        // è™•ç†éŠ·å”®å ±è¡¨
        async function handleSalesFiles(files) {
            const fileList = document.getElementById('salesFileList');
            
            for (let file of files) {
                try {
                    const data = await readExcelFile(file);
                    const fileName = file.name.replace('.xls', '').replace('.xlsx', '');
                    
                    salesDataList.push({
                        name: fileName,
                        data: data
                    });

                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>ğŸ“„ ${fileName}ï¼ˆ${data.length.toLocaleString()} ç­†è³‡æ–™ï¼‰</span>
                        <button class="remove-btn" onclick="removeSalesFile('${fileName}')">ç§»é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                } catch (error) {
                    console.error('è®€å–å¤±æ•—:', file.name, error);
                }
            }

            if (salesDataList.length > 0 && refData) {
                document.getElementById('analysisSection').classList.remove('hidden');
                updatePeriodSelect();
            }
        }

        // ç§»é™¤éŠ·å”®æª”æ¡ˆ
        function removeSalesFile(fileName) {
            salesDataList = salesDataList.filter(item => item.name !== fileName);
            updateFileList();
        }

        // æ¸…é™¤æ‰€æœ‰éŠ·å”®æª”æ¡ˆ
        function clearSalesFiles() {
            salesDataList = [];
            document.getElementById('salesFileList').innerHTML = '';
            document.getElementById('analysisSection').classList.add('hidden');
        }

        // æ›´æ–°æª”æ¡ˆåˆ—è¡¨
        function updateFileList() {
            const fileList = document.getElementById('salesFileList');
            fileList.innerHTML = '';
            salesDataList.forEach(item => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>ğŸ“„ ${item.name}ï¼ˆ${item.data.length.toLocaleString()} ç­†è³‡æ–™ï¼‰</span>
                    <button class="remove-btn" onclick="removeSalesFile('${item.name}')">ç§»é™¤</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // æ›´æ–°é€±æœŸé¸æ“‡
        function updatePeriodSelect() {
            const select = document.getElementById('periodSelect');
            select.innerHTML = '';
            salesDataList.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                option.selected = true;
                select.appendChild(option);
            });
        }

        // è®€å–Excelæ–‡ä»¶
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // åˆ†ææ•¸æ“š
        function analyzeData() {
            if (!refData || salesDataList.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³åƒç…§è³‡æ–™å’ŒéŠ·å”®å ±è¡¨ï¼');
                return;
            }

            const selectedPeriods = Array.from(document.getElementById('periodSelect').selectedOptions).map(o => o.value);
            const regionId = document.getElementById('regionSelect').value;
            const storeId = document.getElementById('storeSelect').value;

            if (selectedPeriods.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é€±æœŸï¼');
                return;
            }

            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            setTimeout(() => {
                try {
                    processedData = processData(selectedPeriods, regionId, storeId);
                    displayResults(processedData);
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                } catch (error) {
                    alert('è™•ç†æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                    document.getElementById('loadingSection').classList.add('hidden');
                }
            }, 500);
        }

        // è™•ç†æ•¸æ“š
        function processData(selectedPeriods, regionId, storeId) {
            // å»ºç«‹ç”¢å“åˆ†é¡å°æ‡‰è¡¨
            const categoryMap = {};
            refData.forEach(row => {
                if (row.Code) {
                    categoryMap[row.Code] = row['å¤§åˆ†é¡'] || 'Unknown';
                }
            });

            // å–å¾—è¦åˆ†æçš„åº—é‹ª
            let targetStores = [];
            if (regionId === 'all') {
                Object.values(REGIONS).forEach(region => {
                    targetStores.push(...region.stores);
                });
            } else if (storeId === 'all') {
                targetStores = REGIONS[regionId].stores;
            } else {
                targetStores = [parseInt(storeId)];
            }

            // è™•ç†æ¯å€‹é€±æœŸçš„æ•¸æ“š
            const results = [];
            selectedPeriods.forEach(periodName => {
                const salesItem = salesDataList.find(item => item.name === periodName);
                if (!salesItem) return;

                const periodData = {
                    period: periodName,
                    categories: {}
                };

                // åˆå§‹åŒ–åˆ†é¡
                MAIN_CATEGORIES.forEach(cat => {
                    periodData.categories[cat] = {
                        qty: 0,
                        amt: 0,
                        cost: 0,
                        adj: 0
                    };
                });

                // çµ±è¨ˆæ•¸æ“š
                salesItem.data.forEach(row => {
                    if (!targetStores.includes(row.store_code_id)) return;

                    const category = categoryMap[row.product_code] || 'Unknown';
                    if (!MAIN_CATEGORIES.includes(category)) return;

                    periodData.categories[category].qty += row.total_qty || 0;
                    periodData.categories[category].amt += row.total_amt_t1 || 0;
                    periodData.categories[category].cost += row.total_cost || 0;
                    periodData.categories[category].adj += row.total_ADJ_COST || 0;
                });

                results.push(periodData);
            });

            return results;
        }

        // é¡¯ç¤ºçµæœ
        function displayResults(data) {
            displayStatCards(data);
            displaySummaryTable(data);
            displayDetailTable(data);
            displayCharts(data);
        }

        // é¡¯ç¤ºçµ±è¨ˆå¡ç‰‡
        function displayStatCards(data) {
            const container = document.getElementById('statCards');
            const totalQty = data.reduce((sum, period) => {
                return sum + Object.values(period.categories).reduce((s, cat) => s + cat.qty, 0);
            }, 0);
            const totalAmt = data.reduce((sum, period) => {
                return sum + Object.values(period.categories).reduce((s, cat) => s + cat.amt, 0);
            }, 0);

            container.innerHTML = `
                <div class="stat-card">
                    <h3>ç¸½éŠ·å”®æ•¸é‡</h3>
                    <div class="value">${totalQty.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>ç¸½éŠ·å”®é‡‘é¡</h3>
                    <div class="value">$${(totalAmt / 1000).toFixed(0)}K</div>
                </div>
                <div class="stat-card">
                    <h3>åˆ†æé€±æœŸæ•¸</h3>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-card">
                    <h3>ç”¢å“åˆ†é¡</h3>
                    <div class="value">${MAIN_CATEGORIES.length}</div>
                </div>
            `;
        }

        // é¡¯ç¤ºæ‘˜è¦è¡¨æ ¼
        function displaySummaryTable(data) {
            const container = document.getElementById('summaryTable');
            
            // è¨ˆç®—å„åˆ†é¡ç¸½è¨ˆ
            const summary = {};
            MAIN_CATEGORIES.forEach(cat => {
                summary[cat] = { qty: 0, amt: 0, profit: 0 };
            });

            data.forEach(period => {
                Object.entries(period.categories).forEach(([cat, values]) => {
                    summary[cat].qty += values.qty;
                    summary[cat].amt += values.amt;
                    summary[cat].profit += (values.amt - values.cost + values.adj);
                });
            });

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>å¤§åˆ†é¡</th>
                            <th class="number-cell">ç¸½éŠ·å”®æ•¸é‡</th>
                            <th class="number-cell">ç¸½éŠ·å”®é‡‘é¡</th>
                            <th class="number-cell">æ¯›åˆ©é¡</th>
                            <th class="number-cell">æ¯›åˆ©ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(summary).forEach(([cat, values]) => {
                const profitRate = values.amt > 0 ? (values.profit / values.amt * 100) : 0;
                html += `
                    <tr>
                        <td><strong>${cat}</strong></td>
                        <td class="number-cell">${values.qty.toLocaleString()}</td>
                        <td class="number-cell">$${values.amt.toLocaleString('zh-TW', {maximumFractionDigits: 0})}</td>
                        <td class="number-cell">$${values.profit.toLocaleString('zh-TW', {maximumFractionDigits: 0})}</td>
                        <td class="number-cell">${profitRate.toFixed(2)}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // é¡¯ç¤ºè©³ç´°è¡¨æ ¼
        function displayDetailTable(data) {
            const container = document.getElementById('detailTable');
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>é€±æœŸ</th>
                            ${MAIN_CATEGORIES.map(cat => `<th class="number-cell">${cat}<br>æ•¸é‡</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(period => {
                html += `<tr><td><strong>${period.period}</strong></td>`;
                MAIN_CATEGORIES.forEach(cat => {
                    const qty = period.categories[cat]?.qty || 0;
                    html += `<td class="number-cell">${qty.toLocaleString()}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // é¡¯ç¤ºåœ–è¡¨
        function displayCharts(data) {
            const labels = data.map(d => d.period);
            
            // æ•¸é‡åœ–è¡¨
            const qtyDatasets = MAIN_CATEGORIES.map((cat, index) => ({
                label: cat,
                data: data.map(d => d.categories[cat]?.qty || 0),
                borderColor: getColor(index),
                backgroundColor: getColor(index, 0.1),
                borderWidth: 2,
                tension: 0.4
            }));

            const qtyCtx = document.getElementById('qtyChart');
            if (window.qtyChart) window.qtyChart.destroy();
            window.qtyChart = new Chart(qtyCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: qtyDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // é‡‘é¡åœ–è¡¨
            const amtDatasets = MAIN_CATEGORIES.map((cat, index) => ({
                label: cat,
                data: data.map(d => d.categories[cat]?.amt || 0),
                borderColor: getColor(index),
                backgroundColor: getColor(index, 0.1),
                borderWidth: 2,
                tension: 0.4
            }));

            const amtCtx = document.getElementById('amtChart');
            if (window.amtChart) window.amtChart.destroy();
            window.amtChart = new Chart(amtCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: amtDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // å–å¾—é¡è‰²
        function getColor(index, alpha = 1) {
            const colors = [
                `rgba(102, 126, 234, ${alpha})`,
                `rgba(118, 75, 162, ${alpha})`,
                `rgba(237, 100, 166, ${alpha})`,
                `rgba(255, 71, 87, ${alpha})`,
                `rgba(46, 213, 115, ${alpha})`,
                `rgba(0, 184, 148, ${alpha})`,
                `rgba(255, 177, 66, ${alpha})`,
                `rgba(253, 121, 168, ${alpha})`,
                `rgba(99, 110, 250, ${alpha})`
            ];
            return colors[index % colors.length];
        }

        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // å€åŸŸæ”¹è®Šæ™‚æ›´æ–°åº—é‹ªé¸é …
        document.getElementById('regionSelect').addEventListener('change', function() {
            const regionId = this.value;
            const storeSelect = document.getElementById('storeSelect');
            storeSelect.innerHTML = '<option value="all">å…¨éƒ¨åº—é‹ª</option>';
            
            if (regionId !== 'all') {
                REGIONS[regionId].stores.forEach(storeId => {
                    const option = document.createElement('option');
                    option.value = storeId;
                    option.textContent = `åº—é‹ª ${storeId}`;
                    storeSelect.appendChild(option);
                });
            }
        });
    </script>
</body>
</html>
